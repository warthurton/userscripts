name: Sync to Publish Branch

on:
    push:
        branches:
            - main
        paths:
            - "userscripts/**/*.user.js"

permissions:
    contents: write

jobs:
    sync-to-publish:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout main branch
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Setup Git config
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"

            - name: Checkout publish branch
              run: git checkout publish || git checkout --orphan publish

            - name: Clear publish branch
              run: git rm -rf . || true

            - name: Copy scripts from main in flat structure
              run: |
                  git checkout main -- userscripts/
                  find userscripts -name "*.user.js" -exec bash -c 'cp "$1" "$(basename "$1")"' _ {} \;
                  rm -rf userscripts

            - name: Update URLs in scripts
              run: |
                  for file in *.user.js; do
                      sed -i "s|https://raw.githubusercontent.com/warthurton/userscripts/main/userscripts/[^/]*/|https://raw.githubusercontent.com/warthurton/userscripts/publish/|g" "$file"
                  done

            - name: Commit and push
              run: |
                  git add *.user.js
                  git commit -m "Sync userscripts from main ($(date -u +'%Y-%m-%d %H:%M:%S UTC'))" || echo "No changes to commit"
                  git push -u origin publish

            - name: Create summary
              run: |
                  echo "## Publish Sync Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Synced the following scripts to the publish branch:" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  ls -1 *.user.js | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
