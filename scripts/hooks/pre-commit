#!/bin/bash
# Pre-commit hook for automatic PATCH version bumping
# Increments the PATCH version in all modified .user.js files

# Get list of modified .user.js files
MODIFIED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.user\.js$')

if [ -z "$MODIFIED_FILES" ]; then
    exit 0
fi

echo "[pre-commit] Updating PATCH versions..."

for file in $MODIFIED_FILES; do
    if [ -f "$file" ]; then
        # Extract current version
        CURRENT_VERSION=$(grep -m 1 '// @version' "$file" | grep -oP '\d+\.\d+\.\d+')
        
        if [ -n "$CURRENT_VERSION" ]; then
            # Parse version components
            MAJOR=$(echo "$CURRENT_VERSION" | cut -d. -f1)
            MINOR=$(echo "$CURRENT_VERSION" | cut -d. -f2)
            PATCH=$(echo "$CURRENT_VERSION" | cut -d. -f3)
            
            # Increment PATCH
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            
            # Update version in file
            sed -i "s|// @version      $CURRENT_VERSION|// @version      $NEW_VERSION|g" "$file"
            
            # Stage the updated file
            git add "$file"
            
            echo "[pre-commit] Updated $file: $CURRENT_VERSION -> $NEW_VERSION"
        else
            echo "[pre-commit] Warning: Could not find version in $file"
        fi
    fi
done

exit 0
